# SPDX-FileCopyrightText: 2024 Jonah Br√ºchert <jbb@kaidan.im>
#
# SPDX-License-Identifier: AGPL-3.0-or-later

- name: Create motis directory
  file:
    path: /opt/motis/
    state: directory

- name: Unpack MOTIS (frontend)
  unarchive:
    src: https://github.com/motis-project/motis/releases/download/v2.8.3/motis-linux-amd64.tar.bz2
    dest: /opt/motis/
    remote_src: yes

- name: Increase nproc for nginx workers
  pam_limits:
    domain: www-data
    limit_type: hard
    limit_item: nproc
    value: '5000'

- name: Increase nofile for nginx workers
  pam_limits:
    domain: www-data
    limit_type: hard
    limit_item: nofile
    value: '5000'

- name: Install nginx
  apt:
    update_cache: true
    name:
     - nginx
     - certbot

- name: Create nginx cache directory
  file:
    path: /var/cache/nginx
    state: directory

- name: Install nginx config
  copy:
    src: nginx.conf
    dest: /etc/nginx/nginx.conf

- name: Install nginx logrotate config
  copy:
    src: logrotate-nginx
    dest: /etc/logrotate.d/nginx

- name: Install 403 error page
  copy:
    src: error403.html
    dest: /var/www/html/error403.html

- name: Install robots.txt
  copy:
    src: robots.txt
    dest: /var/www/html/robots.txt

- name: Install site config
  template:
    src: "transitous.conf.j2"
    dest: "/etc/nginx/sites-available/{{ item.vhost }}"
  with_items:
    - vhost: api.transitous.org
      quic_options: "reuseport" # reuseport can only be used once, automatically applies to all uses of the port
      backends:
        - address: 10.11.1.1:8080
          options: "backup" # nginx backend options
        - address: 10.11.1.3:8080
          options: ""
    - vhost: staging.api.transitous.org
      quic_options: ""
      backends:
        - address: 10.11.1.2:8080
          options: ""
        - address: 10.11.1.1:8080
          options: "backup"

- name: Disable default site configuration
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: Enable nginx sites
  file:
    src: "/etc/nginx/sites-available/{{ item.vhost }}"
    dest: "/etc/nginx/sites-enabled/{{ item.vhost }}"
    state: link
  with_items:
    - vhost: api.transitous.org
    - vhost: staging.api.transitous.org

- name: Reload nginx
  systemd:
    name: nginx.service
    state: reloaded

# For now, initial certificate generation is not handled, run `certbot certonly --noninteractive --agree-tos --standalone --email "root@vm-motis-proxy.spline.de" --domains api.transitous.org --dry-run`
# `certbot certonly --noninteractive --agree-tos --webroot --email "root@vm-motis-proxy.spline.de" --domains api.transitous.org -w /var/www/html --force-renewal` once nginx is running
- name: Enable certbot auto-renewal
  systemd:
    name: certbot.timer
    state: started
    enabled: true

- name: Make sure nginx is running
  systemd:
    name: nginx.service
    state: started

- name: Install nginx log exporter config
  copy:
    src: prometheus-nginxlog-exporter.hcl
    dest: /etc/prometheus-nginxlog-exporter.hcl

- name: Install nginx log exporter
  apt:
    deb: https://github.com/martin-helmich/prometheus-nginxlog-exporter/releases/download/v1.11.0/prometheus-nginxlog-exporter_1.11.0_linux_arm64.deb

- name: Make sure nginx log exporter is running
  systemd:
    name: prometheus-nginxlog-exporter
    state: started
    enabled: true
